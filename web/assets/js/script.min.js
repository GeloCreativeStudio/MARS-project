let audio,amp,fft,isPressed=!0,myShader,angle=0,jitter=0;function preload(){audio=loadSound("assets/audio/intro.mp3"),myShader=loadShader("assets/shader/vertex.vert","assets/shader/fragment.frag"),frameRate(60)}function setup(){let e=createCanvas(300,300,WEBGL);e.parent("head"),e.class("canvas"),shader(myShader),amp=new p5.Amplitude,fft=new p5.FFT}function draw(){background(0),drawingContext.filter="blur(px)",console.log(audio.currentTime()),fft.analyze();let e=amp.getLevel(),a=fft.getCentroid();a*=.001,second()%2==0&&(jitter=random(0,.1),jitter+=jitter),angle+=jitter,rotateX(sin(a)+.1*angle),rotateY(cos(e)+.1*angle);let s=map(a,0,1,0,20),t=map(e,0,.2,0,.5);console.log(),myShader.setUniform("uTime",frameCount),myShader.setUniform("uFreq",s),myShader.setUniform("uAmp",t),sphere(100,400,400)}const rec_play=new Audio("static/sfx/rec_play.mp3"),rec_stop=new Audio("static/sfx/rec_stop.mp3"),processingSound=new Audio("static/sfx/processing.mp3");processingSound.volume=1;const marsImage=document.querySelector(".img-fluid");marsImage.draggable=!1,marsImage.ondragstart=marsImage.oncontextmenu=e=>e.preventDefault(),$(document).ready(()=>{let e=$("#record-button"),a=$("#transcription-box"),s=$("#ask-button"),t=$("#audio-element")[0],i=[],n,r=[],o=!1,l=e=>{e.addClass("no-click").prop("disabled",!0)},c=e=>{e.removeClass("no-click").prop("disabled",!1)},d=()=>{new TypeIt("#response-text",{strings:[],speed:1,waitUntilVisible:!0,cursorChar:"|"}).go()};var p=null;let u=()=>{l(e),l(s),s.html("<i class='fas fa-cog fa-spin'></i>"),i.push({role:"user",content:a.val()}),p&&(i[0].thread_id=p);let t={conversation:i};processingSound.play(),$.ajax({type:"POST",url:"/initiate_query",data:JSON.stringify(t),contentType:"application/json",success(a){processingSound.pause(),processingSound.currentTime=0,$("#response-text")[0].innerHTML="",new TypeIt("#response-text",{strings:a.text,speed:1,waitUntilVisible:!1,cursorChar:"|"}).go(),audio=loadSound(a.audio,()=>{audio.play()}),c(e),c(s),s.html("<i class='fas fa-paper-plane'></i>"),p=a.thread_id}})},m=()=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{(n=new MediaRecorder(t)).ondataavailable=e=>{r.push(e.data)},n.onstop=()=>{l(e),l(s),e.html("<i class='fas fa-sync-alt fa-spin'></i>");let t=new Blob(r,{type:"audio/wav"}),i=new FormData;i.append("file",t,"audio.wav"),processingSound.play(),$.ajax({type:"POST",url:"/audio_transcription",data:i,contentType:!1,processData:!1,success(t){processingSound.pause(),processingSound.currentTime=0,a.val(t.text),c(e),e.html("<i class='ri-mic-line'></i>"),s.click()}})}})},g=()=>{o?(rec_play.play(),n.stop(),o=!1):(rec_stop.play(),e.html("<i class='ri-mic-off-line'></i>"),r=[],n.start(),o=!0)},f=()=>{marsImage.classList.add("scale-down")},y=()=>{marsImage.classList.remove("scale-down")};s.click(u),e.click(g),t.addEventListener("play",f),t.addEventListener("ended",y),d(),m()});